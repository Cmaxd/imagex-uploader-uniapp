!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Uploader={})}(this,(function(e){"use strict";class t{static create(...e){return new this(...e)}mixIn(e){return Object.assign(this,e)}clone(){const e=new this.constructor;return Object.assign(e,this),e}}class s extends t{constructor(e=[],t=4*e.length){super();let s=e;if(s instanceof ArrayBuffer&&(s=new Uint8Array(s)),(s instanceof Int8Array||s instanceof Uint8ClampedArray||s instanceof Int16Array||s instanceof Uint16Array||s instanceof Int32Array||s instanceof Uint32Array||s instanceof Float32Array||s instanceof Float64Array)&&(s=new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),s instanceof Uint8Array){const e=s.byteLength,t=[];for(let i=0;i<e;i+=1)t[i>>>2]|=s[i]<<24-i%4*8;this.words=t,this.sigBytes=e}else this.words=e,this.sigBytes=t}static random(e){const t=[],i=e=>{let t=e,s=987654321;const i=4294967295;return()=>{s=36969*(65535&s)+(s>>16)&i,t=18e3*(65535&t)+(t>>16)&i;let e=(s<<16)+t&i;return e/=4294967296,e+=.5,e*(Math.random()>.5?1:-1)}};for(let s,r=0;r<e;r+=4){const e=i(4294967296*(s||Math.random()));s=987654071*e(),t.push(4294967296*e()|0)}return new s(t,e)}toString(e=i){return e.stringify(this)}concat(e){const t=this.words,s=e.words,i=this.sigBytes,r=e.sigBytes;if(this.clamp(),i%4)for(let e=0;e<r;e+=1){const r=s[e>>>2]>>>24-e%4*8&255;t[i+e>>>2]|=r<<24-(i+e)%4*8}else for(let e=0;e<r;e+=4)t[i+e>>>2]=s[e>>>2];return this.sigBytes+=r,this}clamp(){const{words:e,sigBytes:t}=this;e[t>>>2]&=4294967295<<32-t%4*8,e.length=Math.ceil(t/4)}clone(){const e=super.clone.call(this);return e.words=this.words.slice(0),e}}const i={stringify(e){const{words:t,sigBytes:s}=e,i=[];for(let e=0;e<s;e+=1){const s=t[e>>>2]>>>24-e%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse(e){const t=e.length,i=[];for(let s=0;s<t;s+=2)i[s>>>3]|=parseInt(e.substr(s,2),16)<<24-s%8*4;return new s(i,t/2)}},r={stringify(e){const{words:t,sigBytes:s}=e,i=[];for(let e=0;e<s;e+=1){const s=t[e>>>2]>>>24-e%4*8&255;i.push(String.fromCharCode(s))}return i.join("")},parse(e){const t=e.length,i=[];for(let s=0;s<t;s+=1)i[s>>>2]|=(255&e.charCodeAt(s))<<24-s%4*8;return new s(i,t)}},n={stringify(e){try{return decodeURIComponent(escape(r.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:e=>r.parse(unescape(encodeURIComponent(e)))};class o extends t{constructor(){super(),this._minBufferSize=0}reset(){this._data=new s,this._nDataBytes=0}_append(e){let t=e;"string"==typeof t&&(t=n.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_process(e){let t;const{_data:i,blockSize:r}=this,n=i.words,o=i.sigBytes;let a=o/(4*r);a=e?Math.ceil(a):Math.max((0|a)-this._minBufferSize,0);const h=a*r,c=Math.min(4*h,o);if(h){for(let e=0;e<h;e+=r)this._doProcessBlock(n,e);t=n.splice(0,h),i.sigBytes-=c}return new s(t,c)}clone(){const e=super.clone.call(this);return e._data=this._data.clone(),e}}class a extends o{constructor(e){super(),this.blockSize=16,this.cfg=Object.assign(new t,e),this.reset()}static _createHelper(e){return(t,s)=>new e(s).finalize(t)}static _createHmacHelper(e){return(t,s)=>new h(e,s).finalize(t)}reset(){super.reset.call(this),this._doReset()}update(e){return this._append(e),this._process(),this}finalize(e){e&&this._append(e);return this._doFinalize()}}class h extends t{constructor(e,t){super();const s=new e;this._hasher=s;let i=t;"string"==typeof i&&(i=n.parse(i));const r=s.blockSize,o=4*r;i.sigBytes>o&&(i=s.finalize(t)),i.clamp();const a=i.clone();this._oKey=a;const h=i.clone();this._iKey=h;const c=a.words,p=h.words;for(let e=0;e<r;e+=1)c[e]^=1549556828,p[e]^=909522486;a.sigBytes=o,h.sigBytes=o,this.reset()}reset(){const e=this._hasher;e.reset(),e.update(this._iKey)}update(e){return this._hasher.update(e),this}finalize(e){const t=this._hasher,s=t.finalize(e);t.reset();return t.finalize(this._oKey.clone().concat(s))}}const c=[],p=[],l=e=>{const t=Math.sqrt(e);for(let s=2;s<=t;s+=1)if(!(e%s))return!1;return!0},d=e=>4294967296*(e-(0|e))|0;let u=2,_=0;for(;_<64;)l(u)&&(_<8&&(c[_]=d(u**.5)),p[_]=d(u**(1/3)),_+=1),u+=1;const f=[];class g extends a{_doReset(){this._hash=new s(c.slice(0))}_doProcessBlock(e,t){const s=this._hash.words;let i=s[0],r=s[1],n=s[2],o=s[3],a=s[4],h=s[5],c=s[6],l=s[7];for(let s=0;s<64;s+=1){if(s<16)f[s]=0|e[t+s];else{const e=f[s-15],t=(e<<25|e>>>7)^(e<<14|e>>>18)^e>>>3,i=f[s-2],r=(i<<15|i>>>17)^(i<<13|i>>>19)^i>>>10;f[s]=t+f[s-7]+r+f[s-16]}const d=i&r^i&n^r&n,u=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),_=l+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&h^~a&c)+p[s]+f[s];l=c,c=h,h=a,a=o+_|0,o=n,n=r,r=i,i=_+(u+d)|0}s[0]=s[0]+i|0,s[1]=s[1]+r|0,s[2]=s[2]+n|0,s[3]=s[3]+o|0,s[4]=s[4]+a|0,s[5]=s[5]+h|0,s[6]=s[6]+c|0,s[7]=s[7]+l|0}_doFinalize(){const e=this._data,t=e.words,s=8*this._nDataBytes,i=8*e.sigBytes;return t[i>>>5]|=128<<24-i%32,t[14+(i+64>>>9<<4)]=Math.floor(s/4294967296),t[15+(i+64>>>9<<4)]=s,e.sigBytes=4*t.length,this._process(),this._hash}clone(){const e=super.clone.call(this);return e._hash=this._hash.clone(),e}}const m=a._createHelper(g),y=a._createHmacHelper(g),b=["authorization","content-type","content-length","user-agent","presigned-expires","expect","x-amzn-trace-id"],v=e=>{try{return encodeURIComponent(e).replace(/[^A-Za-z0-9_.~\-%]+/g,escape).replace(/[*]/g,(e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`))}catch(e){return""}},k=e=>Object.keys(e).sort().map((t=>{const s=e[t];if(null==s)return;const i=v(t);return i?Array.isArray(s)?`${i}=${s.map(v).sort().join(`&${i}=`)}`:`${i}=${v(s)}`:void 0})).filter((e=>e)).join("&");class O{constructor(e,t,s){this.request=e,this.request.headers=e.headers||{},this.serviceName=t,s=s||{},this.signatureCache="boolean"!=typeof s.signatureCache||s.signatureCache,this.operation=s.operation,this.signatureVersion=s.signatureVersion,this.constant=s.isVolcengine?{algorithm:"HMAC-SHA256",v4Identifier:"request",dateHeader:"X-Date",tokenHeader:"x-security-token",contentSha256Header:"X-Content-Sha256",kDatePrefix:""}:{algorithm:"AWS4-HMAC-SHA256",v4Identifier:"aws4_request",dateHeader:"X-Amz-Date",tokenHeader:"x-amz-security-token",contentSha256Header:"X-Amz-Content-Sha256",kDatePrefix:"AWS4"},this.bodySha256=s.bodySha256}addAuthorization(e,t){const s=this.iso8601(t).replace(/[:\-]|\.\d{3}/g,"");this.addHeaders(e,s),this.request.headers.Authorization=this.authorization(e,s)}addHeaders(e,t){if(this.request.headers[this.constant.dateHeader]=t,e.sessionToken&&(this.request.headers[this.constant.tokenHeader]=e.sessionToken),this.request.body){let e=this.request.body;"string"!=typeof e&&(e=e instanceof URLSearchParams?e.toString():JSON.stringify(e)),this.request.headers[this.constant.contentSha256Header]=this.bodySha256||S.crypto.sha256(e).toString()}}authorization(e,t){const s=[],i=this.credentialString(t);return s.push(`${this.constant.algorithm} Credential=${e.accessKeyId}/${i}`),s.push(`SignedHeaders=${this.signedHeaders()}`),s.push(`Signature=${this.signature(e,t)}`),s.join(", ")}signature(e,t){const s=this.getSigningKey(e,t.substr(0,8),this.request.region,this.serviceName,this.signatureCache);return S.crypto.hmac(s,this.stringToSign(t),"hex")}stringToSign(e){const t=[];return t.push(this.constant.algorithm),t.push(e),t.push(this.credentialString(e)),t.push(this.hexEncodedHash(this.canonicalString())),t.join("\n")}canonicalString(){const e=[],t=this.request.pathname||"/";return e.push(this.request.method.toUpperCase()),e.push(t),e.push(k(this.request.params)||""),e.push(`${this.canonicalHeaders()}\n`),e.push(this.signedHeaders()),e.push(this.hexEncodedBodyHash()),e.join("\n")}canonicalHeaders(){const e=[];Object.keys(this.request.headers).forEach((t=>{e.push([t,this.request.headers[t]])})),e.sort(((e,t)=>e[0].toLowerCase()<t[0].toLowerCase()?-1:1));const t=[];return e.forEach((e=>{const s=e[0].toLowerCase();if(this.isSignableHeader(s)){const i=e[1];if(null==i||"function"!=typeof i.toString)throw new Error(`Header ${s} contains invalid value`);t.push(`${s}:${this.canonicalHeaderValues(i.toString())}`)}})),t.join("\n")}canonicalHeaderValues(e){return e.replace(/\s+/g," ").replace(/^\s+|\s+$/g,"")}signedHeaders(){const e=[];return Object.keys(this.request.headers).forEach((t=>{t=t.toLowerCase(),this.isSignableHeader(t)&&e.push(t)})),e.sort().join(";")}credentialString(e){return this.createScope(e.substr(0,8),this.request.region,this.serviceName)}hexEncodedHash(e){return S.crypto.sha256(e)}hexEncodedBodyHash(){return this.request.headers[this.constant.contentSha256Header]?this.request.headers[this.constant.contentSha256Header]:this.request.body?this.hexEncodedHash(k(this.request.body)):this.hexEncodedHash("")}isSignableHeader(e){return 0===e.toLowerCase().indexOf("x-amz-")||b.indexOf(e)<0}iso8601(e){return void 0===e&&(e=new Date),e.toISOString().replace(/\.\d{3}Z$/,"Z")}getSigningKey(e,t,s,i){const r=S.crypto.hmac(`${this.constant.kDatePrefix}${e.secretAccessKey}`,t),n=S.crypto.hmac(r,s),o=S.crypto.hmac(n,i);return S.crypto.hmac(o,this.constant.v4Identifier)}createScope(e,t,s){return[e.substr(0,8),t,s,this.constant.v4Identifier].join("/")}}const x={cn:"cn-north-1",us:"us-east-1",sg:"ap-singapore-1","cn-north-1":"cn-north-1","us-east-1":"us-east-1","ap-singapore-1":"ap-singapore-1"},E={"cn-north-1":"https://imagex.volcengineapi.com","us-east-1":"https://imagex-us-east-1.volcengineapi.com","ap-singapore-1":"https://imagex-ap-singapore-1.volcengineapi.com"},w=(e={})=>Object.keys(e).map((t=>`${t}=${e[t]}`)).join("&"),S={crypto:{hmac:function(e,t){return y(t,e)},sha256:function(e){return m(e)}},toQueryString:w,date:{iso8601:e=>(void 0===e&&(e=S.date.getDate()),e.toISOString().replace(/\.\d{3}Z$/,"Z"))},formatOpenApiRequest:(e={params:{},method:"GET",serviceName:"imagex",config:{}})=>new Promise(((t,s)=>{const{params:i,method:r,config:n,serviceName:o}=e,a=x[n.region],h=E[a],{AccessKeyId:c,AccessKeyID:p,SecretAccessKey:l,SessionToken:d}=n.stsToken;let u={method:r,url:`${h}?${w(i)}`,timeout:3e4,region:a,params:i,success:e=>{const i=e.data;if(i.ResponseMetadata.Error)s(i);else{const{Result:e}=i;t(e)}},fail:e=>{s(e)}};const _=new O(u,o,{isVolcengine:!0}),f=n.timeGap?new Date((new Date).getTime()+n.timeGap):new Date;_.addAuthorization({accessKeyId:c||p,secretAccessKey:l,sessionToken:d},f),u.header=u.headers,delete u.headers,uni.request(u)}))},j=void 0,P={"Content-Type":"application/json; charset=utf-8"};let I={};I={cn:"https://mcs.snssdk.com",va:"https://maliva-mcs.byteoversea.com",sg:"https://sgali-mcs.byteoversea.com"};var A,T=Object.freeze({__proto__:null,TEA_CACHE_PREFIX:"__tea_cache_",HEADER_PARAMS:P,get REPORT_PREFIXS(){return I},get WEBID_URL(){return"/v1/user/webid"},get SSID_URL(){return"/v1/user/ssid"},get REPORT_URL(){return"/v1/list"},ET_URL:"",PROFILE_PREFIXS:{cn:"https://dpprofile.snssdk.com",sg:"https://sgali-dpprofile.byteoversea.com",va:"https://vaali-dpprofile.byteoversea.com"},PROFILE_PATH:"/profile/list",DEFAULT_DOMAIN:1,REPORT_CHANNEL:"cn",REPORT_INTERVAL:5e3,MAX_BATCH_EVENT:5,MAX_STORAGE_NUM:-1,AUTO_REPORT:!1,AUTO_PROFILE:!1,PROFILE_CHANNEL:"cn",DISABLE_STORAGE:!0,ENABLE_STORAGE:!1,ENABLE_AB_TEST:!1,CHANNEL_DOMAIN:"",BATCH_NUMBER:30,ENABLE_ET_TEST:!1,ENABLE_FILTER_LIST:!1,WHITE_API:"",CUSTOM_REPORT_URL:"",ENABLE_PROFILE:!1,AB_CHANNEL_DOMAIN:"",ENABLE_FILTER_CRAWLER:!1,EVENT_VERIFY_URL:"",ENABLE_COMPATIBLE_OLD:!0});class q{constructor(){this._pluginInstances=[],this._listeners={},this._pluginInstances=[],this._keyPrefix="__tea_cache_",this._inited=!1,this._sended=!1,this._tokenOK=!1,this._whiteOK=!1,this._verifyStatus=!1,this._options={report_domain:1,report_channel:"cn",report_interval:5e3,max_batch_event:5,max_storage_num:-1,auto_report:!1,auto_profile:!1,profile_channel:"cn",disable_storage:!0,enable_storage:!1,enable_ab_test:!1,channel_domain:"",enable_et_test:!1,enable_filter_list:!1,report_url:"",enable_profile:!1,ab_channel_domain:"",enable_filter_crawler:!1,event_verify_url:"",enable_compatible_old:!0},this._envInfo={user:{web_id:j,ssid:j,user_unique_id:j,user_id:j,user_type:j,user_is_auth:j,user_is_login:j,ip_addr_id:j,device_id:j},header:{app_id:j,app_name:j,app_install_id:j,install_id:j,app_package:j,app_channel:j,app_version:j,os_name:j,os_version:j,device_model:j,device_brand:j,traffic_type:j,client_ip:j,os_api:j,access:j,language:j,app_language:j,creative_id:j,ad_id:j,campaign_id:j,ab_client:j,ab_version:j,platform:j,sdk_version:j,sdk_lib:j,app_region:j,region:j,province:j,city:j,timezone:j,tz_offset:j,tz_name:j,sim_region:j,carrier:j,resolution:j,screen_width:j,screen_height:j,browser:j,browser_version:j,referrer:j,referrer_host:j,utm_source:j,utm_medium:j,utm_campaign:j,utm_term:j,utm_content:j,custom:{},ab_sdk_version:j,_sdk_version:j,_sdk_name:j}},this._ready=!1,this._extraData={},this.storage=new(this._get("storage")),this.logger=new(this._get("logger")),this.request=this._get("request"),this._initPlugin(),this._process()}static use(e,t={type:"plugin"}){const{name:s,type:i}=t;if("plugin"===i)if(s){let t=!1;for(let i=0,r=q.plugins.length;i<r;i++){const r=q.plugins[i];r.name&&r.name===s&&(t=!0,q.plugins[i].plugin=e)}t||q.plugins.push({name:s,plugin:e})}else q.plugins.push({plugin:e});else"adapter"===i&&(q.adapters[s]=e(q,t))}_initPlugin(){try{q.plugins.reduce(((e,t)=>{const{plugin:s}=t;return e.push(new s(this)),e}),this._pluginInstances)}catch(e){}}_on(e,t){e&&t&&"function"==typeof t&&(this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t))}_once(e,t){if(!e||!t||"function"!=typeof t)return;const s=(i,r)=>{t(i,r),this._off(e,s)};this._on(e,s)}_emit(e,t){"report"!==e&&(void 0===t?this.logger.info(`触发${e}`):this.logger.info(`触发${e}：`,t));const s=this._listeners[e];if(s&&s.length)try{[...s].forEach((e=>e(this,t)))}catch(e){}}_off(e,t){e&&this._listeners[e]&&this._listeners[e].length&&(t?this._listeners[e].splice(this._listeners[e].indexOf(t),1):this._listeners[e]=[])}_get(e){return q.adapters[e]}get appId(){return this._appId}set appId(e){if("number"!=typeof e)throw new Error("app_id must be a number");this._appId=e}_mergeEnv(e){this._emit("before-merge",e),((e,t)=>{Object.keys(t).forEach((s=>{if("evtParams"===s)e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),t.evtParams||{});else if("_staging_flag"===s)e.evtParams=Object.assign(Object.assign({},e.evtParams||{}),{_staging_flag:t._staging_flag});else{let i=s,r=t[s];if(null===r)return!1;let n="";i.indexOf(".")>-1&&([n,i]=i.split(".")),"os_version"!==i&&"mp_platform"!==i||(r=`${r}`),n?("headers"===n&&(n="header"),"user"===n||"header"===n?e[n][i]=r:e.header.custom[i]=r):e.user.hasOwnProperty(i)?["user_type","ip_addr_id"].indexOf(i)>-1?e.user[i]=Number(r):["user_id","web_id","user_unique_id","ssid"].indexOf(i)>-1?e.user[i]=String(r):["user_is_auth","user_is_login"].indexOf(i)>-1?e.user[i]=Boolean(r):["device_id"].indexOf(i)>-1&&(e.user[i]=r):e.header.hasOwnProperty(i)?e.header[i]=r:e.header.custom[i]=r}}))})(this._envInfo,e)}_setExtraData(e,t){this._extraData[e]=t}_getExtraData(e=""){return e?this._extraData[e]:this._extraData}destroy(){this._pluginInstances.forEach((e=>e.destroy()))}_process(){this._once("init",(()=>{this._emit("instantiation"),this._mergeEnv({app_id:this.appId}),this._options.auto_report?this._emit("auto-report"):this._emit("not-auto-report"),this._options.enable_ab_test&&this._emit("ab-test"),this._options.enable_filter_list&&this._emit("fetch-white"),this._options.enable_filter_crawler&&this._emit("filter-crawler"),this._emit("device"),this._on("config",((e,t)=>{let{user_unique_id:s}=t,i=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(t,["user_unique_id"]);if(this._mergeEnv(i),!this._options.enable_third&&void 0!==s){s=`${s}`;const{user:e}=this._envInfo;e._user_unique_id?(e._user_unique_id=s,this._emit("profile-clear")):e.web_id?e.user_unique_id!==s&&(e._user_unique_id=s,this._emit("profile-clear"),this._tokenOK=!1,this._emit("stop-report"),this._emit("fetch-ssid",{user_unique_id:s,web_id:e.web_id})):(e._user_unique_id=s,this._emit("profile-clear"))}})),this._once("send",(()=>{this._on("token-ok",(()=>{this._emit("start-report")})),this._tokenOK&&this._emit("start-report")})),this._on("fetch-ssid-complete",((e,t)=>{const{status:s}=t;if(2===s)this._emit("fetch-ssid-complete-done",t),this._tokenOK=!0,this._emit("token-ok");else if(1===s)this.logger.error("获取ssid失败");else if(0===s){const{user:e}=this._envInfo;this._emit("fetch-ssid",{user_unique_id:e._user_unique_id,web_id:e.web_id})}})),this._once("fetch-token-complete",((e,t)=>{if(t){const{user:{_user_unique_id:e,user_unique_id:t,web_id:s}}=this._envInfo;e?t!==e?this._emit("fetch-ssid",{user_unique_id:e,web_id:s}):(delete this._envInfo.user._user_unique_id,this._tokenOK=!0,this._emit("token-ok")):(this._tokenOK=!0,this._emit("token-ok"))}else this._once("fetch-webid-complete",((e,t)=>{if(t){const{user:{_user_unique_id:e,web_id:t}}=this._envInfo;this._envInfo.user.user_unique_id=t,e?this._emit("fetch-ssid",{user_unique_id:e,web_id:t}):(this._tokenOK=!0,this._emit("token-ok"))}else this.logger.error("获取webid失败")})),this._emit("fetch-webid")})),this._emit("fetch-token")}))}_tokenMiddleware(e){this._tokenOK?e():this._once("token-ok",(()=>{e()}))}_sendMiddleware(e){this._sended?e():this._once("send",(()=>{e()}))}_whiteMiddleware(e){this._options.enable_filter_list?this._whiteOK?e():this._once("fetch-white-complete",(()=>{e()})):e()}_compose(e){return e.reverse().reduce(((e,t)=>()=>t((()=>e()))))}}q.adapters={},q.plugins=[];class C extends q{constructor(){super(),this._hooks={}}on(e,t){e&&t&&"function"==typeof t&&(this._hooks[e]||(this._hooks[e]=[]),this._hooks[e].push(t))}once(e,t){if(!e||!t||"function"!=typeof t)return;const s=i=>{t(i),this.off(e,s)};this.on(e,s)}off(e,t){e&&this._hooks[e]&&this._hooks[e].length&&(t?this._hooks[e].splice(this._hooks[e].indexOf(t),1):this._hooks[e]=[])}emit(e,t){e&&this._hooks[e]&&this._hooks[e].length&&[...this._hooks[e]].forEach((e=>{try{e(t)}catch(e){}}))}}!function(e){e.Init="init",e.Instantiation="instantiation",e.AutoReport="auto-report",e.AbTest="ab-test",e.FetchWhite="fetch-white",e.Device="device",e.Config="config",e.StopReport="stop-report",e.FetchSsid="fetch-ssid",e.Send="send",e.TokenOk="token-ok",e.StartReport="start-report",e.FetchSsidComplete="fetch-ssid-complete",e.FetchSsidCompleteDone="fetch-ssid-complete-done",e.ProfileClear="profile-clear",e.FetchTokenComplete="fetch-token-complete",e.FetchWebidComplete="fetch-webid-complete",e.FetchWebid="fetch-webid",e.FetchToken="fetch-token",e.FetchWhiteComplete="fetch-white-complete",e.BeforeMerge="before-merge",e.BeforeConfig="before-config",e.Verify="verify",e.ImmediateReportBatch="immediate-report-batch",e.ImmediateReport="immediate-report",e.Event="event",e.Profile="profile",e.ProfileOnce="profile-once",e.AbVar="ab-var",e.AbAllvars="ab-allvars",e.ProfileSet="profile-set",e.ProfileSetOnce="profile-set-once",e.ProfileUnset="profile-unset",e.ProfileIncrement="profile-increment",e.ProfileAppend="profile-append",e.FetchSsidCompleteHook="fetch-ssid-complete-hook",e.VerifyDomain="verify-domain",e.VerifyOpen="verify-open",e.IntervalReport="interval-report",e.Report="report",e.ProfileInfo="profile-info",e.ReportOption="report-option",e.ReportComplete="report-complete",e.BatchReportComplete="batch-report-complete",e.VerifyClose="verify-close",e.AbExposure="ab-exposure",e.FilterCrawler="filter-crawler",e.ClearStorage="clear-storage",e.ReportBefore="report-before",e.ReportAfter="report-after",e.AppShow="app-show",e.AppHide="app-hide",e.PageShow="page-show",e.PageHide="page-hide",e.AbVersionChange="ab-version-change",e.NotAutoReport="not-auto-report",e.ExternalAbVersion="external-ab-version"}(A||(A={}));const D={appOnShow:"app_launch",appOnHide:"app_terminate",appOnError:"on_error",pageOnShow:"predefine_pageview",pageOnHide:"predefine_pageview_hide",pageOnShareAppMessage:"on_share"},R=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"],N={isCrawler:"iscrawler"};var H;!function(e){e.True="true",e.False="false"}(H||(H={}));const U=["__profile_set","__profile_set_once","__profile_increment","__profile_unset","__profile_append"],$="applog_trace";var L=Object.freeze({__proto__:null,get PluginTypes(){return A},Events:D,Utms:R,ExtraData:N,get FirstTime(){return H},Profiles:U,Trace:$}),B=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));const M=e=>{let t=e;try{t=decodeURIComponent(e)}catch(e){}return t},K=()=>+new Date;class V extends C{getConfig(){return JSON.parse(JSON.stringify(this._envInfo))}init(e){if(!this._inited){if(this._inited=!0,"object"==typeof e){if(this.appId=e.app_id,void 0!==e.log&&(this.logger.setEnable(e.log),delete e.log),void 0===e.report_channel&&void 0!==e.report_domain){let{report_domain:t}=e;t=parseInt(String(t),10),[1,2].includes(t)||(t=1),e.report_channel=1===t?"cn":"sg"}void 0!==e.channel&&(e.report_channel=e.channel),this._options=Object.assign(Object.assign({},this._options),e);let{disable_storage:t,enable_storage:s}=e;void 0!==s?(s=!!s,t=!s,this._options.disable_storage=t,this._options.enable_storage=s):void 0!==t&&(t=!!t,s=!t,this._options.disable_storage=t,this._options.enable_storage=s)}else this.appId=e;this._emit("init")}}config(e){if(!this._inited)return;void 0!==e.log&&(this.logger.setEnable(e.log),delete e.log),e=Object.assign({},e);let{user_unique_id:t}=e,s=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(e,["user_unique_id"]);void 0!==t&&this._emit("config",{user_unique_id:t}),this._emit("before-config",s),this._emit("config",s)}send(){this._inited&&(this._sended=!0,this._emit("send"))}_filterEvent({current:e,isBlack:t,eventNames:s,eventParams:i,whiteEvents:r}){const{event:n,params:o}=e;if(r.includes(n))return e;if(t){if(s.includes(n))return null;if(i[n]&&Array.isArray(i[n]))return Object.assign(Object.assign({},e),{params:Object.keys(o).filter((e=>!i[n].includes(e))).reduce(((e,t)=>(e[t]=o[t],e)),{})})}else{if(!s.length)return e;if(!s.includes(n))return null;if(i[n]&&Array.isArray(i[n]))return Object.assign(Object.assign({},e),{params:Object.keys(o).filter((e=>i[n].includes(e))).reduce(((e,t)=>(e[t]=o[t],e)),{})})}return e}_verify(e){this._verifyStatus&&this._emit("verify",e)}_event(e,t,s=!1){if(this._getExtraData(N.isCrawler))return;const i=()=>{if(s||!this._options.enable_filter_list)return this._emit(e,t),void this._verify(t);const i=this._getExtraData("white");if(!i||void 0===i.is_black)return this._emit(e,t),void this._verify(t);const r=this._getExtraData("white-events"),{is_black:n=1,events:o=[],params:a={}}=i||{};if(Array.isArray(t)){const s=t.reduce(((e,t)=>{const s=this._filterEvent({current:t,isBlack:n,eventNames:o,eventParams:a,whiteEvents:r});return null!==s&&e.push(s),e}),[]);s.length&&(this._emit(e,s),this._verify(s))}else{const s=this._filterEvent({current:t,isBlack:n,eventNames:o,eventParams:a,whiteEvents:r});null!==s&&(this._emit(e,s),this._verify(s))}},r=["immediate-report-batch","immediate-report"].includes(e);this._whiteMiddleware((()=>{r?this._ready?i():this._once("start-report",(()=>{i()})):i()}))}_mergeAbToEvent(e,t=!1){if(this._options.enable_ab_test){const{local_time_ms:s}=e,i=this._getExtraData("ab_versions")||[];let r=null;if(t)i.length>0&&(r=i[i.length-1].ab);else for(let e=0,t=i.length;e<t;e++){const{time:t,ab:n}=i[e];if(t>s)break;r=n}return Object.assign(Object.assign({},e),r?{ab_sdk_version:r}:{})}return e}_createEvent(e,t,s=K()){const i=this._getExtraData("session_id");return Object.assign(Object.assign({event:e,params:t||{}},i?{session_id:i}:{}),{local_time_ms:s})}event(e,t={},s=!1){if(Array.isArray(e)){if(e.length>30){for(;this.event(e.splice(0,30)),0!==e.length;);return!0}const t=[],s=K(),i=(e,i,r)=>{if(e&&"string"==typeof e){let n=r;(!n||"number"!=typeof n||n>s)&&(n=s),t.push(this._mergeAbToEvent(this._createEvent(e,i,n)))}};return e.forEach((e=>{if(Array.isArray(e)){const[t,s,r]=e;i(t,s,r)}else{const{event:t,params:s,local_time_ms:r}=e;i(t,s,r)}})),t.length&&this._event("immediate-report-batch",t),!0}const i=this._mergeAbToEvent(this._createEvent(e,t));if(s)return this._event("immediate-report",i),!0;const{disable_storage:r,enable_storage:n}=this._options;return r||!n?(this._event("immediate-report",i),!0):(this._event("event",i),!0)}}class F{constructor(e){this.sdk=e,this.apply()}getUrl(e){const{_options:t}=this.sdk,{channel_domain:s}=t;let i="";if(s)i=s;else{let{report_channel:e}=t;Object.keys(I).includes(e)||(e="cn"),i=I[e]}switch(e){case"report":return`${i}/v1/list`;case"webid":return`${i}/v1/user/webid`;case"ssid":return`${i}/v1/user/ssid`;case"profile":return`${i}/profile/list`}}_merge(e,t=[]){const{user:s,header:i,evtParams:r}=this.sdk._envInfo,n=e.map((e=>(e.event&&!t.includes(e.event)&&r&&Object.keys(r).forEach((t=>{void 0===e.params[t]&&(e.params[t]=r[t])})),e.params=JSON.stringify(e.params),e))),o=JSON.parse(JSON.stringify({events:n,user:s,header:i}));return o.header.headers&&(o.header.headers=JSON.stringify(o.header.headers)),o.local_time=Math.floor(K()/1e3),[o]}destroy(){this.sdk=null}}const z=(e,t)=>{t.logger.info(e)};var J,W,G;!function(e){e.Mp="mp",e.Quick="quick",e.QG="qg"}(J||(J={})),function(e){e.Launch="launch",e.Terminate="terminate",e.Auto="auto",e.Event="event",e.LogData="log_data",e.Profile="profile"}(W||(W={})),function(e){e.Net="net",e.FailNet="f_net",e.FailData="f_data"}(G||(G={}));var X;class Z extends V{stash(e,t={}){this._getExtraData("session_id");const s=this._mergeAbToEvent(this._createEvent(e,t),!0),i="stash";let r=this._getExtraData(i)||[];return r=[...r,s],this._setExtraData(i,r),!0}commit(){const e=this._getExtraData("stash")||[];return e.length>0&&this.event(e),!0}setProfile(e){this.logger.warn("[deprecated]请示用profileSet、profileSetOnce等新方法")}setOnceProfile(e){this.setProfile(e)}getVar(e,t,s){this._emit("ab-var",{name:e,defaultValue:t,callback:s})}getAllVars(e){this._emit("ab-allvars",e)}getAbSdkVersion(){const e=this._getExtraData("ab_versions")||[];return e.length>0?e[e.length-1].ab:""}onAbSdkVersionChange(e){if(e&&"function"==typeof e){const t=(t,s)=>{setTimeout((()=>{try{e&&e(s)}catch(e){}}),0)},s=this._getExtraData("ab_version_change_cb")||new Map;return s.set(e,t),this._setExtraData("ab_version_change_cb",s),this._on("ab-version-change",t),()=>{s.delete(e),this._off("ab-version-change",t)}}return()=>{}}offAbSdkVersionChange(e){if(e&&"function"==typeof e){const t=this._getExtraData("ab_version_change_cb");if(!t||!t.has(e))return;const s=t.get(e);t.delete(e),s&&this._off("ab-version-change",s)}}getToken(e){const t=()=>{const{user:t}=this._envInfo;return e(Object.assign({},t))};this._tokenOK?t():this._once("token-ok",(()=>{t()}))}autoInitializationRangers(e){const{onTokenReady:t}=e,s=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(e,["onTokenReady"]);this.init(Object.assign(Object.assign({},s),{log:!1,enable_third:!0})),t&&this.getToken((e=>{const{web_id:s}=e;try{"function"==typeof t&&t(`${s}`)}catch(e){}})),this.send()}profileSet(e){this._emit("profile-set",e)}profileSetOnce(e){this._emit("profile-set-once",e)}profileUnset(e){this._emit("profile-unset",e)}profileIncrement(e){this._emit("profile-increment",e)}profileAppend(e){this._emit("profile-append",e)}setExternalAbVersion(e){this._emit("external-ab-version","string"==typeof e&&e?`${e}`.trim():null)}}Z.use(class extends F{apply(){this.maxExpire=7344e6,this.minUpdateTime=432e7,this.sdk._on("fetch-token",(e=>{this.fetchCacheToken((e=>this.sdk._emit("fetch-token-complete",e)))})),this.sdk._on("fetch-webid",(e=>{this.requestWebid((e=>this.sdk._emit("fetch-webid-complete",e)))})),this.sdk._on("fetch-ssid",((e,t)=>{this.requestSsid(t,{completeHook:e=>this.sdk._emit("fetch-ssid-complete-hook",e),complete:e=>this.sdk._emit("fetch-ssid-complete",e)})})),this.sdk._on("instantiation",(e=>{const{storage:t,_options:s}=this.sdk;if(!s.enable_compatible_old)return;const i=this.getKey();let r=t.get(i);if(r&&"string"==typeof r){this.sdk.logger.info("cacheToken-string",r);try{r=JSON.parse(r);const{web_id:e,ssid:s,timestamp:n}=r;this.sdk.logger.info("cacheToken-parse",r),e&&s?n||t.set(i,Object.assign(Object.assign({},r),{timestamp:+new Date})):t.remove(i)}catch(e){t.remove(i),this.sdk.logger.error(e)}}}))}fetchCacheToken(e){const{storage:t}=this.sdk,s=this.getKey(),i=t.get(s);i?this._hasCacheToken(e,i):e(!1)}_hasCacheToken(e,t){let s=t;if("string"==typeof s)try{s=JSON.parse(s)}catch(e){}const{user_unique_id:i,web_id:r,ssid:n,timestamp:o}=s;if(!r||!i||!o)return e(!1),!1;const a=K()-parseFloat(o);if(a>=this.maxExpire)return e(!1),!1;const h=()=>{this.sdk.emit("fetch-token",Object.assign({},s));const{user:t}=this.sdk._envInfo;t.user_unique_id=i,t.web_id=r,t.ssid=n,e(!0)};if(a>=this.minUpdateTime)return this._updateWebid(r,(t=>{if(!t)return e(!1),!1;h()})),!1;h()}requestWebid(e){const{appId:t}=this.sdk;this.sdk.request({url:this.getUrl("webid"),method:"POST",data:{app_id:t,url:"-",user_agent:"-",referer:"-",user_unique_id:""},header:Object.assign({},P),success:t=>{this.sdk.logger.info("success-webid",typeof t,t);const{data:s}=t||{};if(!s)return e(!1),!1;0!==s.e?e(!1):this._hasWebid(e,s)},fail:()=>{this.sdk.logger.info("fail-webid"),e(!1)}})}_hasWebid(e,t){const{web_id:s,ssid:i}=t,{user:r}=this.sdk._envInfo;r.web_id=s,r.ssid=i,this.sdk.storage.set(this.getKey(),Object.assign(Object.assign({},r),{user_unique_id:s,timestamp:K()})),e(!0)}_updateWebid(e,t){const{appId:s}=this.sdk;this.sdk.request({url:`${this.getUrl("webid")}/${e}/update`,method:"POST",data:{app_id:s,url:"-",user_agent:"-",referer:"-",user_unique_id:""},header:Object.assign({},P),success:e=>{const{data:s}=e||{};s?0!==s.e?t(!1):this._hasUpdateWebid(t):t(!1)},fail:()=>{t(!1)}})}_hasUpdateWebid(e){const{storage:t}=this.sdk,s=this.getKey(),i=t.get(s);t.set(s,Object.assign(Object.assign({},i||{}),{timestamp:K()})),e(!0)}requestSsid(e,t){const{appId:s}=this.sdk,{user:i}=this.sdk._envInfo,{completeHook:r,complete:n}=t,o=t=>n({status:t,info:e});this.sdk.request({url:this.getUrl("ssid"),method:"POST",data:{app_id:s,web_id:e.web_id,user_unique_id:`${e.user_unique_id}`},header:Object.assign({},P),success:t=>{if(this.sdk.logger.info("success-ssid",typeof t,t),e.user_unique_id!==i._user_unique_id)return void o(0);const{data:s}=t||{};s?0!==s.e?o(1):(r&&r({info:e,data:s}),this._hasSsid(o,e,s)):o(1)},fail:()=>{this.sdk.logger.info("fail-ssid"),e.user_unique_id===i._user_unique_id?o(1):o(0)}})}_hasSsid(e,t,s){const{storage:i}=this.sdk,{user:r}=this.sdk._envInfo,{ssid:n}=s;r.web_id=t.web_id,r.ssid=n,r.user_unique_id=t.user_unique_id,delete r._user_unique_id;const o=this.getKey(),a=i.get(o),{timestamp:h=K()}=a||{};i.set(o,Object.assign(Object.assign({},r),{timestamp:h})),e(2)}getKey(){const{appId:e,_keyPrefix:t}=this.sdk;return`${t}tokens_${e}`}},{name:"token",type:"plugin"}),Z.use(class extends F{apply(){this.cache=[],this.time=100,this.delaying=0,this.sdk._once("init",(e=>{e._options.enable_compatible_old&&this._transformOldKey()})),this.sdk._on("event",((e,t)=>{this.event(t)})),this.sdk._on("clear-storage",(e=>{this.sdk.storage.remove(this.getKey())}))}_transformOldKey(){const{storage:e}=this.sdk,t=this.getKey(!0);try{const s=e.get(t,!0);if(s){e.remove(t);const i=this.getKey(),r=e.get(i,!0);e.set(i,[...s,...r],!0)}}catch(e){}}event(e){this.cache.push(e),this.delaying>0&&clearTimeout(this.delaying),this.delaying=setTimeout((()=>{const e=[...this.cache];this.cache=[],this.delaying=0,this.sync(e)}),this.time)}sync(e){const{_ready:t,storage:s,_options:{max_batch_event:i}}=this.sdk,r=this.getKey();let n=s.get(r);n&&!Array.isArray(n)&&(n=[],this.sdk._emit("clear-storage"));const o=[...n||[],...e];if(!s.set(r,o))return s.remove(r),void this.sdk._event("immediate-report-batch",o);t&&i&&o.length>=i&&(this.sdk._emit("interval-report"),this.sdk._emit("report"))}getKey(e=!1){const{appId:t,_keyPrefix:s}=this.sdk;return e?`${s}events`:`${s}events_${t}`}},{name:"event",type:"plugin"}),Z.use(class extends F{apply(){this.extOptions={},this.reporting=!1,this.time=3e3,this.splitNumber=30,this.splitTime=1500,this.intervalIng=0,this.sdk._once("report-option",((e,t)=>{this.extOptions=t})),this.sdk._once("init",(e=>{const{_options:{disable_storage:t,enable_storage:s}}=this.sdk;t&&!s||this._reissue()})),this.sdk._on("start-report",(e=>{this.sdk._ready=!0;const{_options:{disable_storage:t,enable_storage:s}}=this.sdk;t&&!s||(this.interval(),this.report())})),this.sdk._on("report",((e,t)=>{this.report(t)})),this.sdk._on("immediate-report",((e,t)=>{this.immediateReport(t)})),this.sdk._on("immediate-report-batch",((e,t)=>{this.immediateReportBatch(t)})),this.sdk._on("stop-report",(()=>{this.sdk._ready=!1;const{_options:{disable_storage:e,enable_storage:t}}=this.sdk;e&&!t||this.stop()})),this.sdk._on("interval-report",(()=>{this.interval()})),this.sdk._on("ab-report",((e,{event:t,hook:s})=>{this.immediateReport(t,s)})),this.sdk._on("clear-storage",(e=>{this.sdk.storage.remove(this.getKey("reports"))}))}_reissue(){const{storage:e}=this.sdk,t=this.getKey("reports");try{const s=e.get(t,!0);s&&(e.remove(t),this._reissueProcess(s))}catch(e){}}_reissueProcess(e){const t=Object.keys(e),s=()=>{if(t.length){const i=[];for(let e=0;e<this.splitNumber;e++)t.length&&i.push(t.shift());if(i.length){const t=[];i.forEach((s=>{e[s]&&e[s][0]&&t.push(e[s][0])})),this.doPost(t,this.getRandom(),(e=>{}))}setTimeout(s,this.splitTime)}};s()}interval(){const{_options:{report_interval:e}}=this.sdk;this.stop(),this.intervalIng=setTimeout((()=>{this.sdk._emit("report"),this.intervalIng=0,this.interval()}),e)}stop(){this.intervalIng>0&&clearTimeout(this.intervalIng),this.intervalIng=0}report(e){const{storage:t}=this.sdk,s=this.getKey("events"),i=t.get(s);if(!i||!i.length)return;t.remove(s);const{_options:{max_storage_num:r}}=this.sdk;if(r>0){const e=this.getKey("reports"),s=t.get(e)||{},i=Object.keys(s);if(i.length>=r){const e=i.sort(((e,t)=>{const s=e.split(".")[0],i=t.split(".")[0];return parseFloat(s)-parseFloat(i)}));e&&e[0]&&this.removeReport(e[0])}}const n=this.mergeEvent(i);this.post(n)}immediateReport(e,t){let s=this.mergeEvent([e]);if(t)try{s=t(s)}catch(e){}const i=this.getRandom();this.doPost(s,i,((t,i)=>{this.sdk._emit("report-complete",{event:e,status:t,user:s[0].user,responseData:i})}))}immediateReportBatch(e){const t=this.mergeEvent(e),s=this.getRandom();this.doPost(t,s,((t,s)=>{this.sdk._emit("batch-report-complete",{event:e,status:t,responseData:s})}))}mergeEvent(e){const t=[...U,$];return this._merge(e,t)}post(e,t){let s="";if(t)s=t;else{const{storage:t}=this.sdk,i=this.getKey("reports"),r=t.get(i)||{};s=this.getRandom(),t.set(i,Object.assign(Object.assign({},r||{}),{[s]:e}))}this.doPost(e,s,(e=>{2!==e&&1!==e||this.removeReport(s)}))}doPost(e,t,s){const{dataType:i,header:r,method:n}=this.extOptions,{_options:{report_url:o,event_verify_url:a}}=this.sdk;a&&this.sdk.request({url:`${`${a}`.replace(/\/+$/,"")}/v1/list_test`,method:"POST",data:e}),this.sdk._emit("report-before",e),this.sdk.request({url:o||`${this.getUrl("report")}?tea_sdk_random=${t}`,method:n||"POST",dataType:i,data:e,header:Object.assign(Object.assign({},P),r||{}),success:e=>{const{data:t}=e||{};t?0!==t.e?s(1,t):s(2):s(1,t)},fail:()=>{s(0)},complete:(...e)=>{this.sdk._emit("report-after",e)}})}getKey(e){const{appId:t,_keyPrefix:s}=this.sdk;return`${s}${e}_${t}`}getRandom(){return`${K()}.${Math.floor(1e5*Math.random())}`}removeReport(e){try{const{storage:t}=this.sdk,s=this.getKey("reports");let i=t.get(s);i&&i[e]&&(i=Object.keys(i).reduce(((t,s)=>(s!==e&&(t[s]=i[s]),t)),{})),t.set(s,i)}catch(e){}}destroy(){this.stop(),super.destroy()}},{name:"report",type:"plugin"}),Z.use(class extends F{apply(){this.sdk._once("ab-test",(()=>{const{appId:e,_envInfo:t}=this.sdk;this.appId=e,this.domain=this._getDomain(),this.fetchStatus=0,this.callbacks=[],this.data=null,this.versions=[],this.externalVersions=null,this.sdk._once("start-report",(()=>{if(!this.domain)return this.fetchStatus=2,void this._fetchComplete(null);const{user:e,header:s}=t,{headers:i}=s,r=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(s,["headers"]);this.user=Object.assign({},e),this._fetch(Object.assign(Object.assign({},r),i))})),this._check(),this.sdk._on("ab-var",((e,{name:t,defaultValue:s,callback:i})=>{this.getVar(t,s,i)})),this.sdk._on("ab-allvars",((e,t)=>{this.getAllVars(t)})),this.sdk._on("ab-exposure",((e,t)=>{this.sdk._emit("ab-report",{event:this.sdk._createEvent("abtest_exposure",{}),hook:e=>{const s=e[0];return s.events[0].ab_sdk_version=s.header.ab_sdk_version=`${t}`,[s]}})}))})),this.processExternal()}processExternal(){this.sdk._once("instantiation",(e=>{let t=!1;const s=(e,t)=>{t.forEach((e=>{const{events:t=[]}=e;t.forEach((e=>{U.includes(e.event)||(e.ab_sdk_version=e.ab_sdk_version?`${e.ab_sdk_version},${this.externalVersions}`:this.externalVersions)}))}))},i=(e,i)=>{0===i&&t||(this.externalVersions=e,t?e||(this.sdk._off("report-before",s),t=!1):(t=!0,this.sdk._on("report-before",s)))};this._getExternalVersion(e.appId,i),this.sdk._on("external-ab-version",((e,t)=>{this._setExternalCache(e.appId,t),i(t,1)}))}))}_getExternalVersion(e,t){const s=this._getExternalCache(e);s&&t(s,0)}getAllVars(e){if("function"!=typeof e)return z("回调函数必须为一个函数",this.sdk);const t={callback:e,type:1};2===this.fetchStatus?this._getAllVars(t):this.callbacks.push(t)}getVar(e,t,s){if(!e)return z("变量名不能为空",this.sdk);if(void 0===t)return z("变量没有默认值",this.sdk);if("function"!=typeof s)return z("回调函数必须为一个函数",this.sdk);const i={name:e,defaultValue:t,callback:e=>{try{s(e)}catch(e){}},type:0};2===this.fetchStatus?this._getVar(i):this.callbacks.push(i)}_check(){const e=this._checkExpiration(this.appId);if(e){const{ab_version:t,data:s}=e;t&&t.length&&(this.versions=t,this.data=s,this._configVersions())}}_fetchComplete(e){if(e){this._setDataCache(this.appId,e),this.data=e;const t=[];Object.keys(e).forEach((s=>{const{vid:i}=e[s];i&&t.push(i)}));const s=this.versions.length;this.versions=this.versions.filter((e=>t.includes(e))),this.versions.length!==s&&this._updateVersions()}this.callbacks.forEach((e=>this[0===e.type?"_getVar":"_getAllVars"](e))),this.callbacks=[]}_getAllVars(e){const{callback:t}=e;t(this.data?JSON.parse(JSON.stringify(this.data)):{})}_getVar(e){const{name:t,defaultValue:s,callback:i}=e,{data:r}=this;if(r){if("object"==typeof r[t]&&void 0!==r[t].val){const{vid:e,val:s}=r[t];return e&&(this.versions.includes(e)||(this.versions.push(e),this._updateVersions()),this.sdk._emit("ab-exposure",e)),void i(s)}i(s)}else i(s)}_updateVersions(){this._setVersionCache(this.appId,this.versions),this._configVersions()}_configVersions(){const e=this.versions.join(",");if(e){this.sdk._mergeEnv({ab_sdk_version:e});const t="ab_versions",s=this.sdk._getExtraData(t)||[];this.sdk._setExtraData(t,[...s,{time:K(),ab:e}]),this.sdk._emit("ab-version-change",e)}}_getDomain(){const{_options:e}=this.sdk,{channel_domain:t,ab_channel_domain:s}=e;let i="";return s&&(i=s),i}_url(){return`${this.domain}/service/2/abtest_config/`}_fetch(e,{success:t=(()=>{}),fail:s=(()=>{})}={}){this.fetchStatus=1;const i=this._url();this.sdk.request({url:i,data:{header:Object.assign(Object.assign({aid:this.appId},this.user||{}),e||{})},method:"POST",header:Object.assign({},P),success:(e={})=>{this.fetchStatus=2;const{data:{data:i={}}={}}=e||{};i?(this._fetchComplete(i),t(i)):(this._fetchComplete(null),s())},fail:()=>{this.fetchStatus=2,s(),this._fetchComplete(null)}})}_getStorageKey(e,t=0){return 1===t?`__tea_sdk_ab_version_external_${e}`:`__tea_sdk_ab_version_${e}`}_getExternalCache(e){const{storage:t}=this.sdk;try{return t.get(this._getStorageKey(e,1))}catch(e){}return null}_setExternalCache(e,t){const{storage:s}=this.sdk;try{const i=this._getStorageKey(e,1);t?s.set(i,{val:t}):s.remove(i)}catch(e){}}_getCache(e){const{storage:t}=this.sdk;let s={ab_version:[],data:null,timestamp:K()};try{s=t.get(this._getStorageKey(e))||s}catch(e){}return s}_setCache(e,t){const{storage:s}=this.sdk;try{const i=this._getCache(e);s.set(this._getStorageKey(e),Object.assign(Object.assign({},i),t))}catch(e){}}_setVersionCache(e,t){this._setCache(e,{ab_version:t,timestamp:K()})}_setDataCache(e,t){this._setCache(e,{data:t})}_checkExpiration(e){const{storage:t}=this.sdk,s=this._getCache(e),i=s.timestamp;if(K()-i>=2592e6){try{t.remove("__tea_sdk_ab_version")}catch(e){}return null}return s}},{name:"ab",type:"plugin"}),Z.use(class extends F{apply(){this.cache=[],this.expire=21600,this.timeout=5e3,this.sdk._once("fetch-white",(e=>{this.initWhite((()=>{this.sdk._whiteOK=!0,this.sdk._emit("fetch-white-complete")}))}))}initWhite(e){const{storage:t}=this.sdk,s=this.getKey(),i=t.get(s);this.processCache(e,i,(e=>{t.set(s,e)}))}processCache(e,t,s){t&&t.timestamp&&(this.sdk._setExtraData("white",t.data),(void 0!==t.interval?t.interval:this.expire)+t.timestamp>K())?e():this.requestWhite(((t,i)=>{const r=(e,t)=>{s(Object.assign({timestamp:K(),interval:void 0!==e?e:this.expire},t?{data:t}:{}))};if(t){const{event_list:t,fetch_interval:s}=i;if(!t)return this.sdk._setExtraData("white",null),r(s,null),void e();const{is_block:n}=t,o=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(t,["is_block"]),a=Object.assign(Object.assign({},o),{is_black:n});return this.sdk._setExtraData("white",a),r(s,a),void e()}r(void 0,null),e()}))}_requestWhite(e){setTimeout((()=>{e(!0,{event_list:{is_block:0,events:["app_launch","xxx1","xxx2"],params:{xxx3:["xxx"]}},fetch_interval:3600})}),3e3)}requestWhite(e){const{appId:t}=this.sdk;this.sdk.request({url:"",method:"POST",data:{header:{aid:t},event_filter:1},header:Object.assign({},P),timeout:5e3,success:t=>{const{data:s}=t;try{s.config&&s.config.event_list?e(!0,s.config):e(!1,null)}catch(t){e(!1,null)}},fail:()=>{e(!1,null)}})}getKey(){const{appId:e,_keyPrefix:t}=this.sdk;return`${t}white_${e}`}},{name:"white",type:"plugin"}),Z.use(class extends F{apply(){this.lastId=0,this.lastOnceId=0,this.duration=6e4,this.cache={},this.buffer=[],this.sdk._on("profile-set",((e,t)=>{this._check()&&this.setProfile(t)})),this.sdk._on("profile-set-once",((e,t)=>{this._check()&&this.setOnceProfile(t)})),this.sdk._on("profile-unset",((e,t)=>{this._check()&&this.unsetProfile(t)})),this.sdk._on("profile-increment",((e,t)=>{this._check()&&this.incrementProfile(t)})),this.sdk._on("profile-append",((e,t)=>{this._check()&&this.appendProfile(t)})),this.sdk._on("profile-clear",(e=>{this.cache={}})),this.sdk._on("start-report",(()=>{this.buffer.length&&(this._report([...this.buffer]),this.buffer=[])}))}_check(){return!!this.sdk._options.enable_profile}setProfile(e){const t=this._debounce(e);if(!t)return;this._putCache(t);const s=this._filter(t,(e=>"string"==typeof e||"number"==typeof e||this._isArray(e)));this.report({event:"__profile_set",params:s,local_time_ms:this.ms()})}setOnceProfile(e){const t=this._debounce(e,!0);if(!t)return;this._putCache(t);const s=this._filter(t,(e=>"string"==typeof e||"number"==typeof e||this._isArray(e)));this.report({event:"__profile_set_once",params:s,local_time_ms:this.ms()})}incrementProfile(e){if(!e)return;const t=this._filter(e,(e=>"number"==typeof e));this.report({event:"__profile_increment",params:t,local_time_ms:this.ms()})}unsetProfile(e){if(!e||"string"!=typeof e)return;const t={};t[e]="1",this.report({event:"__profile_unset",params:t,local_time_ms:this.ms()})}appendProfile(e){if(!e||!this._isObject(e)||this._isEmpty(e))return;const t=this._filter(e,(e=>"string"==typeof e||this._isArray(e)));this.report({event:"__profile_append",params:t,local_time_ms:this.ms()})}report(e){this.sdk._ready?this._report([e]):this.buffer.push(e)}_report(e){const t=this._merge(e,[...U]);this.sdk.request({url:`${this.getUrl("profile")}`,method:"POST",dataType:"json",data:t,header:Object.assign({},P),success:e=>{},fail:()=>{}})}ms(){return K()}_debounce(e,t=!1){if(!e||!this._isObject(e)||this._isEmpty(e))return;let s=Object.keys(e);const i=this.ms(),r=s.filter((s=>{const r=this.cache[s];return!r||!(t||this._compare(r.val,e[s])&&i-r.timestamp<this.duration)})).reduce(((t,s)=>(t[s]=e[s],t)),{});return s=Object.keys(r),s.length?r:void 0}_putCache(e){const t=this.ms();Object.keys(e).forEach((s=>{this.cache[s]={val:this._clone(e[s]),timestamp:t}}))}_clone(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}_compare(e,t){return JSON.stringify(e)===JSON.stringify(t)}_filter(e,t){return Object.keys(e).reduce(((s,i)=>{const r=e[i];return t(r)&&(s[i]=r),s}),{})}_isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}_isArray(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)}_isEmpty(e){return!Object.keys(e).length}destroy(){super.destroy()}},{name:"pf",type:"plugin"}),Z.use(class extends F{apply(){this.sdk._on("instantiation",(e=>{const t=(()=>{try{const e=(new Date).getTimezoneOffset();return{timezone:Math.floor(Math.abs(e)/60),offset:60*e}}catch(e){return{timezone:8,offset:-28800}}})();e._mergeEnv({timezone:t.timezone,tz_offset:t.offset})})),this.sdk._on("before-config",((e,t)=>{if(void 0!==t.gender&&([1,2,"1","2"].includes(t.gender)?t.gender=t.gender<2?"male":"female":delete t.gender),e._options.enable_profile){const e={};["nick_name","gender","avatar_url"].forEach((s=>{void 0!==t[s]&&(e[s]=t[s],delete t[s])})),this.sdk._emit("profile-set",e)}})),this.sdk._on("before-merge",((e,t)=>{if(e._options.enable_profile){const e={};["rangers_mp_from_uid"].forEach((s=>{void 0!==t[s]&&(e[s]=t[s],delete t[s])})),Object.keys(e).length>0&&this.sdk._emit("profile-set",e)}}))}},{name:"beforeConfig",type:"plugin"}),Z.use(class extends F{constructor(){super(...arguments),this.platform=J.Mp}apply(){this.sdk._on("instantiation",((e,t)=>{this.aid=e.appId,this.isAuto=!!e._options.auto_report,this.isPrivate=!!e._options.channel_domain})),this.sdk._on("report-before",((e,t)=>{this.isPrivate||this.isTest()||this.parse(t).forEach((e=>{this.collect(e)}))})),this.sdk._on("report-complete",((e,t)=>{if(this.isPrivate)return;if(this.isTest())return;const{status:s}=t;if(2===s)return;const{event:i,user:r,responseData:n}=t,o=[{events:r?[i]:i}],a=1===s?G.FailData:G.FailNet,h=this.parse(o,a);a===G.FailData?this.collect({key:W.Event,state:a},n.sc||h.length):h.forEach((e=>{this.collect(e)}))})),this.sdk._on("app-hide",(e=>{this.commit()}))}parse(e,t=G.Net){const s=[];return e&&e.forEach((e=>{const{events:i}=e;i.forEach((e=>{const{event:i}=e;i!==$&&(this.isTest(e)||s.push({key:this.getKey(i),state:t}))}))})),s}collect(e,t=1){const{key:s,state:i}=e;this.cache||(this.cache=new Map);const{cache:r}=this,n=(e=1)=>({count:e,state:i,key:s,params_for_special:$,platform:this.platform,aid:this.aid,_staging_flag:1});let o=t;if(r.has(s)){let e=r.get(s);if(e.has(i)){const s=e.get(i);s.count+=t,o=s.count}else e.set(i,n(t))}else{const e=new Map;e.set(i,n(t)),r.set(s,e)}o>=100&&this.critical(s,i)}report(e){if(!e)return;const t=this.sdk.appId;if(!t)return;const s=[];e.forEach((e=>{e.forEach((e=>{e.aid||(e.aid=t);const i=this.sdk._createEvent($,e);s.push(i)}))})),s.length>0&&this.sdk._emit("immediate-report-batch",s)}getKey(e){switch(e){case D.appOnShow:return W.Launch;case D.appOnHide:return W.Terminate;default:return Object.values(D).includes(e)?W.Auto:U.includes(e)?W.Profile:W.Event}}critical(e,t){this.commit()}commit(){if(this.isPrivate)return;if(this.isTest())return;const e=this.cache;this.cache=null,this.report(e)}isTest(e){var t,s;return e?!!JSON.parse(e.params)._staging_flag:!!(null===(s=null===(t=this.sdk._envInfo)||void 0===t?void 0:t.evtParams)||void 0===s?void 0:s._staging_flag)}},{name:"trace",type:"plugin"}),function(e){e.Normal="synchronize",e.Once="setOnce"}(X||(X={}));var Q,Y=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s};!function(e){e[e.Crawler=1129]="Crawler"}(Q||(Q={}));class ee extends F{constructor(){super(...arguments),this.Events=D,this.queue=[],this.hasLaunch=!1}apply(){const{sdk:e}=this;this.which=this.getWhich(),e._on("instantiation",(e=>{const t=e._getExtraData("white-events");e._setExtraData("white-events",[...t||[],...Object.values(D)]),this.firstTimeProcess()})),e._on("filter-crawler",(e=>{const{which:t}=this;if(void 0!==t.getLaunchOptionsSync){const{scene:s}=t.getLaunchOptionsSync()||{};s===Q.Crawler&&e._setExtraData(N.isCrawler,!0)}})),e._on("start-report",(()=>{if(this.queue.length>0)for(;;){const e=this.queue.shift();if(!e)break;const{name:t,params:s}=e;this._emitEvent(t,s)}})),e._once("auto-report",(()=>{this.open=!0,this.init(),this.ssidComplete()})),e._once("not-auto-report",(()=>{this.open=!1,this.init()})),this.verify()}getWhich(){return{}}report(e,t){const{sdk:s}=this;s._ready?this._emitEvent(e,t):this.queue.push({name:e,params:t})}_emitEvent(e,t){const{sdk:s}=this;this.hasLaunch||e!==D.appOnShow||(this.hasLaunch=!0),s.event(e,t,!0)}makeUuid(){return B()}_firstTimeKey(){const{appId:e,_keyPrefix:t}=this.sdk;return`${t}first_${e}`}firstTimeProcess(){const e=this._firstTimeKey(),{storage:t}=this.sdk;let s=t.get(e);s!==H.False?(s||(this.firstTime=H.True),t.set(e,H.False)):this.firstTime=H.False}getFirstTimeValue(e){let t;return e?t=H.True:(t=this.firstTime,this.firstTime===H.True&&(this.firstTime=H.False)),t}init(){const{sdk:e}=this;e._setExtraData("session_id",this.makeUuid()),this.proxyApp(),this.proxyPage(),this.proxyComponent()}ssidComplete(){const{sdk:e}=this;e._on("fetch-ssid-complete-hook",((e,t)=>{if(!this.hasLaunch)return;if(this.queue.length>0)return;const s=e._ready;e._ready=!0,e.appHide(!0),e._ready=s})),e._on("fetch-ssid-complete-done",((e,t)=>{this.hasLaunch&&(this.queue.length>0||e.appLaunch(!0))}))}proxyApp(){const e=this.proxyAppHacks();this.appHacks=e,this.proxyAppSdkMethods(),this.proxyAppBefore(),this.proxyAppDo(),this.proxyAppAfter()}proxyAppHacks(){const{sdk:e}=this,t=this,s=this.open?{onShow(s,i=!1){!i&&e._emit("app-show");const r=B();e._setExtraData("session_id",r),e._setExtraData("session_start",K());const{query:{from_uid:n="0",share_depth:o=0}={}}=s;e._setExtraData("from_uid",n),e._setExtraData("share_depth",Number(o)||0),e._setExtraData("session_depth",0);const{scene:a}=s;a&&e._setExtraData("scene",a),t.report(D.appOnShow,(s=>{const{referrerInfo:n}=s,o=Y(s,["referrerInfo"]),{query:a}=o,h=Y(o,["query"]),c=Object.assign(Object.assign({},a),n),p={},l={};let d=!1;Object.keys(c).forEach((e=>{if(R.includes(e))d=!0,l[e]=M(c[e]);else{let t=c[e];"from_title"===e&&(t=encodeURIComponent(M(c[e]))),p[`query_${e}`]=t}})),d&&e._mergeEnv(l);const u=t.getFirstTimeValue(i);return Object.assign(Object.assign({session_id:r,$is_first_time:u},h),p)})(s)),e._mergeEnv({rangers_mp_from_uid:n||"0"})},onHide(s=!1){const i=e._getExtraData("session_start"),r=Math.ceil((K()-i)/1e3),n=e._getExtraData("session_depth"),o=e._getExtraData("session_id"),a=e._getExtraData("scene"),h=getCurrentPages()||[],c=h[h.length-1],{route:p="",options:l={}}=c;t.report(D.appOnHide,(()=>{const e={};return Object.keys(l).forEach((t=>{if(!R.includes(t)){let s=l[t];"from_title"===t&&(s=encodeURIComponent(M(l[t]))),e[`query_${t}`]=s}})),Object.assign(Object.assign({exit_page:p,session_duration:r,session_depth:n,session_id:o},a?{scene:a}:{}),e)})()),!s&&e._emit("app-hide")},onError(s){const i=e._getExtraData("session_id");t.report(D.appOnError,{on_error:s,session_id:i})}}:{onShow(){e._emit("app-show")},onHide(){e._emit("app-hide")}};return this.proxyAppHacksExtend(s),s}proxyAppHacksExtend(e){}proxyAppSdkMethods(){const{sdk:e,which:t,appHacks:s}=this;e.appLaunch=e=>{let i={};void 0!==t.getLaunchOptionsSync&&(i=t.getLaunchOptionsSync()),s.onShow(i||{},e)},e.appHide=e=>{s.onHide(e)},this.open&&(e.appError=e=>{s.onError(e)}),this.proxyAppSdkMethodsExtend(s)}proxyAppSdkMethodsExtend(e){}proxyAppBefore(){}proxyAppDo(){const{appHacks:e}=this,t=App;return App=function(s){return Object.keys(e).forEach((t=>{const i=s[t];s[t]=function(...s){try{e[t].apply(this,s)}catch(e){}return i&&i.apply(this,s)}})),t(s)},t}proxyAppAfter(){}proxyPage(){const e=this.proxyPageHacks();this.pageHacks=e,this.proxyPageSdkMethods(),this.proxyPageBefore(),this.proxyPageDo(),this.proxyPageAfter()}proxyPageHacks(){const{sdk:e}=this,t=this,s=this.open?{onShow(){e._emit("page-show");const s=getCurrentPages(),i=s[s.length-1],{route:r="",options:n={}}=i,o=Number(e._getExtraData("session_depth"))||0;e._setExtraData("session_depth",o+1);const a=e._getExtraData("session_id"),h=e._getExtraData("scene"),c={},p={};let l=!1;Object.keys(n).forEach((e=>{if(R.includes(e))l=!0,p[e]=M(n[e]);else{let t=n[e];"from_title"===e&&(t=encodeURIComponent(M(n[e]))),c[`query_${e}`]=t}})),l&&e._mergeEnv(p);const d=Object.assign(Object.assign({path:r,session_id:a},h?{scene:h}:{}),c);d.title=e._getPageTitle(r);let u=null;const _=e._getExtraData("recently_page");if(_?u=_:s.length>1&&(u=e._getRouteInfo(2,s)),u){const{path:e="",query:t={}}=u;d.refer_path=e,d.refer_query=JSON.stringify(t)}e._setExtraData("recently_page",{path:r,query:n}),e._setExtraData("current_pv_info",{time:K(),params:Object.assign({},d)}),t.report(D.pageOnShow,d)},onHide(){e._emit("page-hide");const s=e._getExtraData("current_pv_info");if(!s)return;e._setExtraData("current_pv_info",null);const{time:i,params:r}=s;t.report(D.pageOnHide,Object.assign(Object.assign({},r||{}),{duration:K()-i}))},onUnload(){s.onHide()},onShareAppMessage(s){const{user:{ssid:i,user_unique_id:r}}=e._envInfo,n=Number(e._getExtraData("share_depth"))+1,o=e._getExtraData("session_id");if(s.path){let{path:e}=s;const{title:t}=s,o=`from_uid=${i}&from_user_unique_id=${r}&share_depth=${n}&from_title=${t}`;let a="";const h=e.indexOf("#");-1!==h&&(a=e.substr(h),e=e.substr(0,h)),-1!==e.indexOf("?")?e+=`&${o}`:e+=`?${o}`,s.path=e+a}return t.report(D.pageOnShareAppMessage,(e=>{const{title:t,path:s=""}=e;return{title:t,path:s,page_path:s.split("?")[0],query_from_uid:i,query_share_depth:n,session_id:o}})(s)),Object.assign(Object.assign({},s),{from_uid:i,share_depth:n})}}:{onShow(){e._emit("page-show")},onHide(){e._emit("page-hide")}};return this.proxyPageHacksExtend(s),s}proxyPageHacksExtend(e){}proxyPageSdkMethods(){const{sdk:e,pageHacks:t}=this;e.predefinePageview=()=>{t.onShow()},e.predefinePageviewHide=()=>{t.onHide()},this.open&&(e.shareAppMessage=e=>t.onShareAppMessage(e)),this.proxyPageSdkMethodsExtend(t)}proxyPageSdkMethodsExtend(e){}proxyPageBefore(){}proxyPageDo(){const{pageHacks:e}=this,t=this,s=Page;return Page=function(i){return Object.keys(e).forEach((s=>{const r=i[s];t.open&&"onShareAppMessage"===s?r&&(i[s]=function(...t){const i=r?r.apply(this,t):{};try{const t=e[s].apply(this,[i]);i.path=t.path}catch(e){}return i}):i[s]=function(...t){try{e[s].apply(this,t)}catch(e){}return r&&r.apply(this,t)}})),s(i)},s}proxyPageAfter(){}proxyComponent(){const e=Component,t=this.pageHacks,s=this;Component=function(i){return i.methods||(i.methods={}),Object.keys(t).forEach((e=>{const r=i.methods[e];s.open&&"onShareAppMessage"===e?r&&(i.methods[e]=function(...s){const i=r?r.apply(this,s):{};try{const s=t[e].apply(this,[i]);i.path=s.path}catch(e){}return i}):i.methods[e]=function(...s){try{t[e].apply(this,s)}catch(e){}return r&&r.apply(this,s)}})),e(i)}}verifyDo(e){const{sdk:t,which:s}=this,i=((e={})=>e&&e.start_rangers_data_check?e.start_rangers_data_check:"")(e);if(t.logger.info(`verify ${i}`),i){t._emit("verify-domain",i);const e=e=>{e||(e={nickName:"未知",avatarUrl:""}),t._emit("verify-open",e),t.logger.info(`${JSON.stringify(e)}`)};s.getSetting({success(i){t.logger.info("getSetting success"),i.authSetting["scope.userInfo"]?(t.logger.info("getSetting scope.userInfo success"),void 0!==s.getUserInfo?s.getUserInfo({success(s){t.logger.info("getUserInfo success");const{nickName:i,avatarUrl:r}=s.userInfo;e({nickName:i,avatarUrl:r})},fail(){t.logger.info("getUserInfo fail"),e()}}):void 0!==s.getOpenUserInfo&&s.getOpenUserInfo({success(s){t.logger.info("getUserInfo success");try{const t=JSON.parse(s.response).response,{nickName:i,avatar:r}=t;e({nickName:i,avatarUrl:r})}catch(e){}},fail(){t.logger.info("getUserInfo fail"),e()}})):(t.logger.info("getSetting scope.userInfo fail"),e())},fail(){t.logger.info("getSetting fail"),e()}})}}verify(){this.sdk._once("app-show",(()=>{const{which:e}=this;try{if(void 0!==e.getLaunchOptionsSync){const t=e.getLaunchOptionsSync(),{query:s}=t;this.verifyDo(s)}}catch(e){}}))}}class te extends F{constructor(){super(...arguments),this.currentPath="",this.titleCaches={}}apply(){this.which=this.getWhich(),this.sdk._getRouteInfo=this.getRouteInfo.bind(this),this.sdk._getPageTitle=this.getPageTitle.bind(this),this.sdk._on("instantiation",(e=>{this.proxySetTitle(),this.onPageChange()}))}getWhich(){return{}}proxySetTitle(){const{which:e,titleCaches:t}=this;try{const s=e=>function(){return function(s){try{const e=getCurrentPages(),r=e[e.length-1].route||"";(null==(i=s)||"[object Object]"!=Object.prototype.toString.call(i))&&(s={}),t[r]=s.title}catch(e){}var i;e.call(this,s)}};if(void 0!==e.setNavigationBarTitle){const t=e.setNavigationBarTitle;Object.defineProperty(e,"setNavigationBarTitle",{get:s(t)})}else if(void 0!==e.setNavigationBar){const t=e.setNavigationBar;Object.defineProperty(e,"setNavigationBar",{get:s(t)})}}catch(e){}}getRouteInfo(e=1,t){try{const s=(t=t||getCurrentPages()).length-e;if(s<0)return null;const{route:i="",options:r={}}=t[s];return{path:i,query:r}}catch(e){}return null}onPageChange(){this.sdk._on("page-show",(e=>{this.getPageUrl()}))}getPageUrl(){try{const e=this.getRouteInfo();if(!e)return;const{path:t,query:s}=e;this.currentPath=t,this.sdk._mergeEnv({evtParams:Object.assign({$current_path:t},s?{$current_query:JSON.stringify(s)}:{})})}catch(e){}}getEnvConfig(){return null}getPageTitle(e){let t="";if(void 0!==this.titleCaches[e]&&(t=this.titleCaches[e]),!t)try{const s=this.getEnvConfig();if(s){const i=s.page[e]||s.page[e+".html"];i&&(t=i.window.navigationBarTitleText),t||(t=s.global.window.navigationBarTitleText)}}catch(e){}return t}}const se="undefined",ie={wx:[0,"miniProduct"],my:[1,"aliMiniProduct"],tt:[2,"ttMiniProduct"],swan:[5,"swanMiniProduct"],qq:[6,"qqMiniProduct"],uni:[7,"uniMiniProduct"]};var re=()=>typeof tt!==se?tt:typeof my!==se?my:typeof swan!==se?swan:typeof qq!==se?qq:typeof wx!==se?wx:typeof uni!==se?uni:{};const{HEADER_PARAMS:ne}=T,{PluginTypes:oe}=L,ae={mpLaunch:"mp_launch",mpEnter:"mp_enter",mpExit:"mp_exit",purchase:"purchase",query:"query",updateLevel:"update_level",createGameRole:"create_gamerole",checkout:"check_out",addToFavourite:"add_to_favourite"};let he;var ce=Object.freeze({__proto__:null,Events:ae,mpLaunch:(e,t)=>{e(ae.mpLaunch,Object.assign({},t))},mpEnter:(e,t)=>{he=+new Date,e(ae.mpEnter,Object.assign({},t))},mpExit:(e,t={})=>{const s=getCurrentPages(),i=s[s.length-1].route,r=void 0===he?0:+new Date-he;e(ae.mpExit,Object.assign({duration:r,page_path:i},t)),he=void 0},purchase:(e,t)=>{e(ae.purchase,Object.assign({},t))},quest:(e,t)=>{e(ae.query,Object.assign({},t))},updateLevel:(e,t)=>{e(ae.updateLevel,Object.assign({},t))},createGameRole:(e,t)=>{e(ae.createGameRole,Object.assign({},t))},checkout:(e,t)=>{e(ae.checkout,Object.assign({},t))},addToFavourite:(e,t)=>{e(ae.addToFavourite,Object.assign({},t))}});const{PluginTypes:pe}=L,{PluginTypes:le}=L;Z.use(class extends F{apply(){this.sdk._on(oe.Device,(e=>{e._mergeEnv({sdk_lib:"mp_common"}),this.getInfo()})),this.sdk._on(oe.AppShow,(e=>{this.getInfo()})),this.sdk._on(oe.Init,(e=>{this.sdk._emit(oe.ReportOption,{dataType:"json",header:Object.assign({},ne)})}))}getInfo(){const{sdk:e}=this,t=re(),s=typeof tt!==se?ie.tt:typeof my!==se?ie.my:typeof swan!==se?ie.swan:typeof qq!==se?ie.qq:typeof wx!==se?ie.wx:typeof uni!==se?ie.uni:[];t&&(t.getSystemInfo&&t.getSystemInfo({success(i){let r={device_brand:i.brand,device_model:i.model,os_version:i.system,os_name:i.platform,platform:i.platform,custom_platform:s[1],resolution:`${i.screenWidth}x${i.screenHeight}`,screen_width:i.screenWidth,screen_height:i.screenHeight};typeof wx===se&&typeof my===se&&typeof swan===se&&typeof qq===se&&typeof uni===se||(r=Object.assign(Object.assign({},r),{language:i.language})),e._mergeEnv(r);const n={mp_platform:s[0],mp_platform_app_version:i.version,mp_platform_basic_version:typeof my!==se?t.SDKVersion:i.SDKVersion};e._mergeEnv(n)}}),t.getNetworkType&&t.getNetworkType({success(t){const s={access:t.networkType};e._mergeEnv(s)}}))}},{type:"plugin"}),Z.use(class extends F{apply(){this.sdk._on(pe.Instantiation,(e=>{const{Events:t}=ce,s=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(s[i[r]]=e[i[r]])}return s}(ce,["Events"]),i=e._getExtraData("white-events");e._setExtraData("white-events",[...i||[],...Object.values(t)]),Object.keys(s).forEach((t=>{e[t]=s[t].bind(null,e.event.bind(e))}))}))}},{type:"plugin"}),Z.use(((e,t)=>class{get(e,t=!1){const s=re();try{if(typeof wx!==se||typeof tt!==se||typeof swan!==se||typeof qq!==se||typeof uni!==se){const t=s.getStorageInfoSync();if(t&&t.keys&&t.keys.includes(e))return s.getStorageSync(e)}else if(typeof my!==se)return s.getStorageSync({key:e}).data}catch(s){t&&this.remove(e)}return null}set(e,t,s=!1){const i=re(),r=()=>{typeof wx!==se||typeof tt!==se||typeof swan!==se||typeof qq!==se||typeof uni!==se?i.setStorageSync(e,t):typeof my!==se&&i.setStorageSync({key:e,data:t})};try{return r(),!0}catch(t){if(s)this.remove(e);else if(e.includes("_reports_")||e.includes("_events_")){this.remove(e);try{return r(),!0}catch(e){}}}return!1}remove(e){const t=re();try{typeof wx!==se||typeof tt!==se||typeof swan!==se||typeof qq!==se||typeof uni!==se?t.removeStorageSync(e):typeof my!==se&&t.removeStorageSync({key:e})}catch(e){}}}),{name:"storage",type:"adapter"}),Z.use(((e,t)=>e=>{const t=Object.assign(Object.assign({},e),{dataType:e.dataType||"json"}),s=re();return typeof my!==se?s[s.request?"request":"httpRequest"](t):s.request(t)}),{name:"request",type:"adapter"}),Z.use(((e,t)=>class extends class{constructor(e){this.enable=!0,this.console=e}setEnable(e){this.enable=e}info(...e){this.enable&&this.console.log(...e)}warn(...e){this.enable&&this.console.warn(...e)}error(...e){this.enable&&this.console.error(...e)}}{constructor(){super(typeof console!==se?console:{info:(...e)=>{},warn:(...e)=>{},error:(...e)=>{}})}}),{name:"logger",type:"adapter"}),Z.use(class extends F{apply(){this.sdk._on(le.Instantiation,(()=>{this.sdk._mergeEnv({sdk_version:"1.6.0",_sdk_version:"1.6.0",_sdk_name:"@dp/tea-sdk-common".replace("@dp/tea-","")||"sdk-common"})}))}},{type:"plugin"}),Z.use(class extends F{apply(){this.test=!1,this.testRequestNumber=0,this.buffer=[],this.sdk._on("verify-domain",((e,t)=>{if(t)try{const e=(e=>(e=>{const t=e=>{return(t="logverify",t.split("").map((e=>e.charCodeAt(0)))).reduce(((e,t)=>e^t),e);var t};return e=>e.match(/.{1,2}/g).map((e=>parseInt(e,16))).map(t).map((e=>String.fromCharCode(e))).join("")})()(e))(t);e&&/^https?:\/\//.test(e)&&(this.domain=e),this.sdk.logger.info(`verify domain ${e}`)}catch(e){}})),this.sdk._once("verify-open",((e,t)=>{this.sdk.logger.info(`verify open ${JSON.stringify(t)}`),this.userInfo=t,this.sdk._verifyStatus=!0,this.sdk._on("verify",((e,t)=>{try{this._pushBuffer(JSON.parse(JSON.stringify(t)))}catch(e){}})),this.login()})),this.sdk._on("verify-close",(e=>{this.userInfo=null,this.sdk._verifyStatus=!1,this.sdk._off("verify")}))}_getUrl(e){let t="";if(this.domain)switch(e){case"login":t=`${this.domain}/simulator/limited_mobile/try_link`;break;case"report":t=`${this.domain}/simulator/limited_mobile/log`}return t}login(){const e=this._getUrl("login");if(!e)return;const{header:t}=this._prepareHeader();this.sdk.request({url:e,method:"POST",data:Object.assign(Object.assign({header:Object.assign(Object.assign({},t||{}),{aid:t.app_id})},this.userInfo?{nick_name:this.userInfo.nickName}:{}),{host_version:(t.custom||{}).mp_platform_app_version||"",sync_id:this.syncId||""}),success:e=>{try{const{data:{data:{retry:t,sync_id:s,token:i}}}=e;if(this.syncId=s,this.token=i,this.test&&this.testRequestNumber>3)return void this.report();0===t||(1===t?this.loginLoop():2===t&&this.report())}catch(e){this.loginLoop()}},fail:()=>{this.loginLoop()}})}loginLoop(){this.test&&this.testRequestNumber++,setTimeout((()=>{this.login()}),1e3)}report(){const e=this._getUrl("report");if(!e)return;const{header:t}=this._prepareHeader(),s=this.buffer;this.buffer=[],this.sdk.request({url:e,method:"POST",data:{header:Object.assign(Object.assign({},t||{}),{aid:t.app_id}),token:this.token||"",event_v3:s||[]},success:e=>{try{const{data:{data:{keep:t}}}=e;!0===t?this.reportLoop():this._destroy()}catch(e){this.reportLoop()}},fail:()=>{this.reportLoop()}})}reportLoop(){setTimeout((()=>{this.report()}),1e3)}_pushBuffer(e){(Array.isArray(e)?[...e]:[e]).forEach((e=>{e.params=JSON.parse(e.params),this.buffer.push(e)}))}_prepareHeader(){const{user:e,header:t}=this.sdk._envInfo;return JSON.parse(JSON.stringify({user:e,header:t}))}_destroy(){this.buffer=[],this.syncId="",this.token=""}},{type:"plugin"}),Z.use(class extends ee{getWhich(){return re()}proxyAppSdkMethodsExtend(e){const{sdk:t}=this;typeof swan!==se&&(e.onLaunch=function(e){t._emit("swan-launch",e)})}proxyAppDo(){const{appHacks:e}=this;if(typeof swan!==se&&"function"==typeof App.after)App.after({methods:Object.assign({},e)});else{const e=super.proxyAppDo();typeof swan!==se&&Object.keys(e).forEach((t=>{App[t]=e[t]}))}}proxyPageSdkMethodsExtend(){}proxyPageDo(){const{pageHacks:e}=this;if(typeof swan!==se&&"function"==typeof Page.after)Page.after({methods:Object.assign({},e)});else{const e=super.proxyPageDo();typeof swan!==se&&Object.keys(e).forEach((t=>{Page[t]=e[t]}))}}proxyComponent(){(typeof my===se||my.canIUse("component2"))&&super.proxyComponent()}verify(){const{sdk:e}=this;if(typeof swan!==se){let t=!1;e._on("swan-launch",((e,s)=>{if(!t){t=!0;try{const{query:e}=s;this.verifyDo(e)}catch(e){}}}))}else super.verify()}},{type:"plugin"}),Z.use(class extends te{getWhich(){return re()}getEnvConfig(){try{if(typeof tt!==se)return __ttConfig;if(typeof wx!==se)return __wxConfig;if(typeof qq!==se)return __qqConfig;if(typeof my!==se)return null;if(typeof swan!==se)return null}catch(e){}return null}},{type:"plugin"});var de=new Z;const ue={browserError:1e3,crc32:1e3,preUpload:1001,initUploadID:1002,process:1003,fileMerge:1004,complete:1005},_e={success:0,error:1,cancel:2,pause:3},fe={video:"video_upload",image:"image_upload",object:"object_upload"},ge={cn:2562,us:2643,sg:2643,"cn-north-1":2562,"us-east-1":2643,"ap-singapore-1":2643},me={cn:"cn",us:"va",sg:"sg","cn-north-1":"cn","us-east-1":"va","ap-singapore-1":"sg"};class ye{constructor(e){this.config=e||{},this.defaultTeaConfig={user_unique_id:this.config.userId||"uniapp_user"},de.init({app_id:ge[this.config.region||"cn"],auto_report:!1,report_channel:me[this.config.region||"cn"]}),de.config(this.defaultTeaConfig),de.send(),this.tea=de}static getLogger(e){return this.tea||(this.tea=new ye(e)),this.tea}log(e={}){const t=e.fileType||"image",s=ue[e.stage]||999;let i={log_type:fe[t],stage:s,fk:e.key,fs:e.fileSize||0,req:e.req,res:e.res,ts:Math.round(Date.now()/1e3),sst:e.stageStartTime,set:e.stageEndTime,dur:e.duration,tdur:e.totalDuration,sdk_version:e.sdk_version,service_id:e.serviceId};const r=`${"image"===t?"image":"video"}_`+("error"===e.type?"error":s);switch(s){case 1001:this.tea.config({...this.defaultTeaConfig,evtParams:{...i,line_app_id:this.config.appId,type:e.type,oid:e.oid,upload_host:e.tosDomain,ex:JSON.stringify({errc:e.extra&&e.extra.errorCode,err:e.extra&&e.extra.error,msg:e.extra&&e.extra.message,sig:e.signature})}});break;case 1003:e.isAllFinish||e.isDirect||(delete i.sst,delete i.set,delete i.dur),this.tea.config({...this.defaultTeaConfig,evtParams:{...i,line_app_id:this.config.appId,type:e.type,oid:e.oid,upload_host:e.tosDomain,ex:JSON.stringify({errc:e.extra&&e.extra.errorCode,msg:e.extra&&e.extra.message,si:e.slice_index,af:e.isAllFinish})}});break;case 1005:this.tea.config({...this.defaultTeaConfig,evtParams:{...i,line_app_id:this.config.appId,type:e.type,oid:e.oid,upload_host:e.tosDomain,ex:JSON.stringify({errc:e.extra&&e.extra.errorCode,err:e.extra&&e.extra.error,msg:e.extra&&e.extra.message,vid:e.uploadResult&&e.uploadResult.Vid})}});break;default:this.tea.config({...this.defaultTeaConfig,evtParams:{...i,line_app_id:this.config.appId,type:e.type,oid:e.oid,upload_host:e.tosDomain,ex:JSON.stringify({errc:e.extra&&e.extra.errorCode,msg:e.extra&&e.extra.message})}})}this.tea.event(r)}}e.default=class{constructor(e){this.config=Object.assign({region:"cn-north-1",userId:"",appId:"",imageConfig:{serviceId:""},videoConfig:{spaceName:""}},e),this.logger=ye.getLogger(this.config)}start(e){this.options=Object.assign({path:"",size:0,type:"video",stsToken:{},correctTime:null,success:()=>{},fail:()=>{},progress:()=>{}},e),this.result={},this.successProcess=this.options.success,this.failProcess=this.options.fail,this.progressProcess=this.options.progress,Date.parse(this.options.correctTime)?this.timeGap=Math.abs(new Date(this.options.correctTime)-new Date)>6e4?new Date(this.options.correctTime)-new Date:0:this.options.correctTime?(this.timeGap=0,console.warn("The correctTime's format is incorrect")):this.timeGap=0,this.preUpload()}async preUpload(){try{const e=await S.formatOpenApiRequest({params:{Action:"ApplyImageUpload",Version:"2018-08-01",ServiceId:this.config.imageConfig.serviceId,UseAppletsHosts:!0},method:"GET",serviceName:"imagex",config:this.config});if(e&&e.UploadAddress){const t=e.UploadAddress,{StoreInfos:s,UploadHosts:i,SessionKey:r,UploadHeader:n={}}=t;Object.assign(this.result,{signature:s[0].Auth,type:"success",extra:{message:"prepare upload success"},stage:"preUpload",oid:s[0].StoreUri,tosDomain:`https://${i[0]}`,UploadHeader:n,SessionKey:r}),this.log({message:"preUpload success",res:JSON.stringify(e),stage:"preUpload",status:"success"}),this.doUpload()}else this.fail({message:"preload fail",res:JSON.stringify(e),stage:"preUpload",status:"error"})}catch(e){this.fail({message:"preload fail",res:JSON.stringify(e||{}),stage:"preUpload",status:"error"})}}doUpload(){this.uploadUrl=this.result.tosDomain+"/"+this.result.oid;const e=this.result.oid.split("/")[1],t={url:this.uploadUrl,filePath:this.options.path,name:e,header:{Authorization:this.result.signature||"","Content-CRC32":"Ignore"},success:e=>{200===e.statusCode?(e.data&&e.data.payload&&(this.result.oid=e.data.payload.key,this.result.hash=e.data.payload.hash),this.commitUpload(),this.log({message:"upload success",stage:"process",status:"success"})):this.fail({message:"upload fail",res:JSON.stringify(e||{}),stage:"process",status:"error"})},fail:e=>{this.fail({message:"upload fail",res:JSON.stringify(e||{}),stage:"process",status:"error"})}};this.uploadTask=uni.uploadFile(t),this.uploadTask.onProgressUpdate((e=>{this.progressProcess(e)}))}async commitUpload(){try{const e=await S.formatOpenApiRequest({params:{Action:"CommitImageUpload",Version:"2018-08-01",SessionKey:this.result.SessionKey,ServiceId:this.config.imageConfig.serviceId},method:"POST",serviceName:"imagex",config:this.config});if(e&&e.Results){const t=e.Results[0];"image"===this.options.type&&Object.assign(t,e.PluginResult&&e.PluginResult[0]),Object.assign(this.result,{stage:"complete",type:"success",percent:100,extra:{message:"upload successful"},uploadResult:t}),this.success(t),this.log({message:"commit upload success",res:JSON.stringify(e),stage:"complete",status:"success"})}else this.fail({message:"commit upload failed",res:JSON.stringify(e||{}),stage:"complete",status:"error"})}catch(e){this.fail({message:"commit upload fail",res:JSON.stringify(e||{}),stage:"complete",status:"error"})}}success(e){this.successProcess(e)}fail(e){this.failProcess(e),this.log(e)}log(e){const t={extra:{},fileSize:this.options.size,msg:e.message,oid:this.result.oid,sdk_version:"uniapp_1.4",uid:this.config.userId||"",appId:this.config.appId||"",fileType:this.options.type,type:e.status,stage:e.stage,status:_e[e.status],res:e.res||"",serviceId:this.config.imageConfig.serviceId||""};this.logger.log(t)}},Object.defineProperty(e,"__esModule",{value:!0})}));
